{# Todo: these should probably be added with js #}
<div class="govuk-form-group">
  <label class="govuk-label" for="school-picker">{{params.label.text}}</label>
  <div id="school-picker" class="app-!-autocomplete--max-width-two-thirds"></div>
</div>

<input name='{{params.name}}' type="hidden" id="school-picker-uuid-input">

<script src="/public/javascripts/autocomplete.min.js"></script>
<script src="https://unpkg.com/lunr/lunr.js"></script>
<script src="/public/javascripts/jquery-1.11.3.js"></script>

<script>
  var element = document.querySelector('#school-picker')

  // LunrJS Search index
  var searchIndex = null
  var documentStore = null

  var statusMessage = null
  var searchQuery = ''
  var searchCallback = function () {}
  var debug = ({{ data.settings.searchDebug or false }}) ? true : false

  // Prefil existing UUID if available
  // Doing it here rather than rendering ensures this field isn’t populated when js isn’t available
  {% if params.uuid %}
    var uuidElement = document.querySelector('#school-picker-uuid-input')
    uuidElement.value = '{{ params.uuid }}'
  {% endif %}

  // Results that are rendered by the autocomplete
  var searchResults = []

  var fetchSearchIndex = (callback) => {
    statusMessage = 'Loading...'
    $.ajax({
      type: 'GET',
      url: `/search-index`,
      success: function(response) {
        searchIndex = lunr.Index.load(response.index)
        documentStore = response.store
        callback(response)
      }
    });
  }

  var renderResults = () => {
    if (!searchIndex || !documentStore) {
      return searchCallback(searchResults)
    }

    // Avoid searching when there is no query
    if (searchQuery.length){
      var lunrSearchResults = searchIndex.query(function (q) {
        let tokens = lunr.tokenizer(searchQuery)
        let lastToken = tokens.pop()
        q.term(tokens, {
          presence: lunr.Query.presence.REQUIRED
        })
        q.term(lastToken, {
          wildcard: lunr.Query.wildcard.TRAILING
        })
      }).slice(0, 15)

      searchResults = lunrSearchResults.map(function (result) {
        let item = documentStore[result.ref]
        item.score = result.score.toFixed(2)
        return item
      })
    }

    if (searchResults.length === 0) {
      statusMessage = 'No results found'
    }
    searchCallback(searchResults)
  }

  var handleSearchQuery = (query, callback) => {
    statusMessage = 'Loading...'
    searchQuery = query
    searchCallback = callback

    renderResults()
  }

  var updateInput = (result) => {
    var element = document.querySelector('#school-picker-uuid-input')
    // If they've picked something, save the UUID of the selection
    if (result){
      element.value = result.uuid
    }
    // Autocomplete closed without making a selection - clear any previous selection
    else element.value = ""
  }

  var inputValue = (result) => {
    if (result) { return result.name }
  }

  var suggestion = (result) => {
    if (result) {
      var name
      if (debug){
        name = `${result.score}: ${result.name}`
      }
      else {
        name = result.name
      }
      var hint = `URN ${result.urn}, ${result.town}, ${result.postcode}`
      return `${name}<span class="autocomplete__option-hint">${hint}</span>`
    }
  }

  accessibleAutocomplete({
    element: element,
    id: 'school-picker',
    source: handleSearchQuery,
    onConfirm: updateInput,
    showAllValues: false,
    autoselect: false,
    minLength: 2,
    defaultValue: '{{params.value}}',
    name: '_autocomplete_raw_value_school_picker',
    templates: {
      inputValue,
      suggestion
    },
    tNoResults: function () { return statusMessage }
  })

  fetchSearchIndex(function () { renderResults() })

  // Try to catch people who press return prematurely and submit an incomplete form
  $('#school-picker').keydown(function (e) {
    if (e.keyCode == 13) {
      e.preventDefault();
      console.log("preventing defaults")
      return false;
    }
  });


</script>
